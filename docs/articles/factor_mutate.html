<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>factor_mutate • seplyr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">seplyr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/seplyr.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/factor_mutate.html">factor_mutate</a>
    </li>
    <li>
      <a href="../articles/MutatePartitioner.html">Mutate Partitioner</a>
    </li>
    <li>
      <a href="../articles/named_map_builder.html">Named Map Builder</a>
    </li>
    <li>
      <a href="../articles/rename_se.html">rename_se</a>
    </li>
    <li>
      <a href="../articles/using_seplyr.html">Using seplyr to Program Over dplyr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>factor_mutate</h1>
                        <h4 class="author">John Mount</h4>
            
            <h4 class="date">2018-02-21</h4>
          </div>

    
    
<div class="contents">
<p>An <a href="https://www.r-project.org"><code>R</code></a> <a href="https://CRAN.R-project.org/package=dplyr"><code>dplyr</code></a> user must, to some extent, be able to know if a <code>dplyr</code> expression is well-formed. The <code>dplyr</code> implementation makes such decisions, so to program <code>dplyr</code> one has to be able to anticipate a least a reasonable subset of these determinations.</p>
<p>Take the following <code>dplyr</code> statement as an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">x =</span> <span class="dv">1</span>,
              <span class="dt">v1 =</span> x,
              <span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
              <span class="dt">v2 =</span> x,
              <span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
              <span class="dt">v3 =</span> x)</code></pre></div>
<p>Would the above be, in the context of a larger <code>dplyr</code> pipeline, be a valid statement?</p>
<p>My personal opinion is: <a href="http://www.win-vector.com/blog/2017/09/my-advice-on-dplyrmutate/">it is not</a>.</p>
<p>The issues include: the statement is (unsafely) using values in the same block they are created, and also re-using variable names across terms. I don’t recall these issues being discussed in <a href="http://dplyr.tidyverse.org/reference/mutate.html"><code>dplyr</code> <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> documentation</a>, and indeed the statement <em>appears</em> to work when used with the in-memory (or on <code>data.frame</code>) version of <code>dplyr</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"dplyr"</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw">packageVersion</span>(<span class="st">"dplyr"</span>)
<span class="co">#&gt; [1] '0.7.4'</span>

d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">z =</span> <span class="dv">1</span>)

d <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">x =</span> <span class="dv">1</span>,
         <span class="dt">v1 =</span> x,
         <span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
         <span class="dt">v2 =</span> x,
         <span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
         <span class="dt">v3 =</span> x) <span class="op">%&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">z</th>
<th align="right">x</th>
<th align="right">v1</th>
<th align="right">v2</th>
<th align="right">v3</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">1</td>
<td align="right">3</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">3</td>
</tr></tbody>
</table>
<p>However “in memory” is not the only place <code>dplyr</code> is promoted and used. <code>dplyr</code> is also often used to talk to <code>SQL</code> back ends (such as <code>Spark</code> and databases). When we try the same <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> in a database context we, currently, get a different (and wrong) result. This establishes the example <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> statement is at best unsafe.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">packageVersion</span>(<span class="st">"dbplyr"</span>)
<span class="co">#&gt; [1] '1.2.1'</span>
<span class="kw">packageVersion</span>(<span class="st">"DBI"</span>)
<span class="co">#&gt; [1] '0.7'</span>
<span class="kw">packageVersion</span>(<span class="st">"RSQLite"</span>)
<span class="co">#&gt; [1] '2.0'</span>

db &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/DBI/topics/dbConnect">dbConnect</a></span>(RSQLite<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/RSQLite/topics/SQLite">SQLite</a></span>(), 
                     <span class="st">":memory:"</span>)
d2 &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/copy_to.html">copy_to</a></span>(db, d, <span class="st">'d2'</span>)

d2 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">x =</span> <span class="dv">1</span>,
         <span class="dt">v1 =</span> x,
         <span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
         <span class="dt">v2 =</span> x,
         <span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
         <span class="dt">v3 =</span> x) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">z</th>
<th align="right">x</th>
<th align="right">v1</th>
<th align="right">v2</th>
<th align="right">v3</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
</tr></tbody>
</table>
<p>The above is an incorrect result, with no warning and no error signaled.<br>
Essentially this is a silent result corruption.</p>
<p>Looking further we can see the issue is likely in the <code>SQL</code> generation path:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d2 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">x =</span> <span class="dv">1</span>,
         <span class="dt">v1 =</span> x,
         <span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
         <span class="dt">v2 =</span> x,
         <span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
         <span class="dt">v3 =</span> x) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()
<span class="op">&lt;</span>SQL<span class="op">&gt;</span>
SELECT <span class="st">`</span><span class="dt">z</span><span class="st">`</span>, <span class="st">`</span><span class="dt">x</span><span class="st">`</span>, <span class="st">`</span><span class="dt">v1</span><span class="st">`</span>, <span class="st">`</span><span class="dt">v2</span><span class="st">`</span>, <span class="st">`</span><span class="dt">x</span><span class="st">`</span> AS <span class="st">`</span><span class="dt">v3</span><span class="st">`</span>
<span class="kw">FROM</span> (SELECT <span class="st">`</span><span class="dt">z</span><span class="st">`</span>, <span class="fl">1.0</span> AS <span class="st">`</span><span class="dt">x</span><span class="st">`</span>, <span class="st">`</span><span class="dt">v1</span><span class="st">`</span>, <span class="st">`</span><span class="dt">x</span><span class="st">`</span> AS <span class="st">`</span><span class="dt">v2</span><span class="st">`</span>
<span class="kw">FROM</span> (SELECT <span class="st">`</span><span class="dt">z</span><span class="st">`</span>, <span class="fl">1.0</span> AS <span class="st">`</span><span class="dt">x</span><span class="st">`</span>, <span class="st">`</span><span class="dt">x</span><span class="st">`</span> AS <span class="st">`</span><span class="dt">v1</span><span class="st">`</span>
<span class="kw">FROM</span> (SELECT <span class="st">`</span><span class="dt">z</span><span class="st">`</span>, <span class="fl">1.0</span> AS <span class="st">`</span><span class="dt">x</span><span class="st">`</span>
FROM <span class="st">`</span><span class="dt">d2</span><span class="st">`</span>)))</code></pre></div>
<p>We have a function in development, <code><a href="http://www.rdocumentation.org/packages/seplyr/topics/factor_mutate">seplyr::factor_mutate()</a></code> which inspects the terms one is considering placing in a <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> (or even a <code>dplyr::sumarize()</code> or <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">dplyr::transmute()</a></code>) and:</p>
<ul>
<li>Issues a warning if the statement is unsafe.</li>
<li>Factors the statement into multiple ordered safe statements.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># # seplyr::factor_mutate() currently </span>
<span class="co"># # requires the dev-version of seplyr</span>
<span class="co"># # version 0.5.2 or better.</span>
<span class="co"># devtools::install_github("WinVector/seplyr")</span>
stmts &lt;-<span class="st"> </span>seplyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/seplyr/topics/factor_mutate">factor_mutate</a></span>(
  <span class="dt">x =</span> <span class="dv">1</span>,
  <span class="dt">v1 =</span> x,
  <span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
  <span class="dt">v2 =</span> x,
  <span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>,
  <span class="dt">v3 =</span> x
)
<span class="co">#&gt; Warning in seplyr::factor_mutate(x = 1, v1 = x, x = x + 1, v2 = x, x = x</span>
<span class="co">#&gt; + : Mutate should be split into more than one stage.</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cat</span>(stmts)
   <span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">x =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">   </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">v1 =</span> x) <span class="op">%&gt;%</span>
<span class="st">   </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">   </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">v2 =</span> x) <span class="op">%&gt;%</span>
<span class="st">   </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">x =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">   </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">v3 =</span> x) </code></pre></div>
<p><code><a href="http://www.rdocumentation.org/packages/seplyr/topics/factor_mutate">seplyr::factor_mutate()</a></code> issues a warning. It also builds statement source code that is safe in the sense that:</p>
<ul>
<li>Term to term dependencies now all cross <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> stages.</li>
<li>Terms in a single <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> stage can be evaluated in any order (without changing results).</li>
</ul>
<p>The statement is partitioned into a minimal (subject to some order constraints) number of new statements (though it is not obvious from this example). In particular statements that can be left alone are left alone (and no warning is issued).</p>
<p>And in fact this code returns the same result on the database as we did on the in-memory example.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> <span class="kw">paste</span>(<span class="st">"d2 %&gt;%"</span>, stmts))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/compute.html">collect</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>()</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">z</th>
<th align="right">x</th>
<th align="right">v1</th>
<th align="right">v2</th>
<th align="right">v3</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">1</td>
<td align="right">3</td>
<td align="right">1</td>
<td align="right">2</td>
<td align="right">3</td>
</tr></tbody>
</table>
<p>We don’t suggest calling <code>eval()</code> in production code. Instead we suggest using <code><a href="http://www.rdocumentation.org/packages/seplyr/topics/factor_mutate">seplyr::factor_mutate()</a></code> to inspect code as you are writing, and to incorporate its advice in your best practices.</p>
<p>The important distinction is: the in-memory code seems to have (possibly undocumented) strict sequential semantics (terms are guaranteed to be evaluated in order in a single <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>), and database implementations do not have such a property. Thus we need to organize code to be completely unambiguous even with terms re-ordered with a <em>single</em> <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> stage. This is a service that the <code><a href="http://www.rdocumentation.org/packages/seplyr/topics/factor_mutate">seplyr::factor_mutate()</a></code> method attempts to heuristically supply, and something <em>central</em> to the design of <a href="https://winvector.github.io/rquery/"><code>rquery</code></a> (a <code>SQL</code>-only data processing system).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DBI<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/DBI/topics/dbDisconnect">dbDisconnect</a></span>(db)</code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
