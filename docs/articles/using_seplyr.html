<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using seplyr to Program Over dplyr • seplyr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">seplyr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/seplyr.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mutate.html">mutate</a>
    </li>
    <li>
      <a href="../articles/MutatePartitioner.html">Mutate Partitioner</a>
    </li>
    <li>
      <a href="../articles/named_map_builder.html">Named Map Builder</a>
    </li>
    <li>
      <a href="../articles/rename_se.html">rename_se</a>
    </li>
    <li>
      <a href="../articles/StringAlgebra.html">String Algebra</a>
    </li>
    <li>
      <a href="../articles/using_seplyr.html">Using seplyr to Program Over dplyr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Using seplyr to Program Over dplyr</h1>
                        <h4 class="author">John Mount</h4>
            
            <h4 class="date">2017-11-21</h4>
          </div>

    
    
<div class="contents">
<p><a href="https://github.com/WinVector/seplyr"><code>seplyr</code></a> is an <a href="https://www.r-project.org"><code>R</code></a> package that makes it easy to program over <a href="https://CRAN.R-project.org/package=dplyr"><code>dplyr</code> <code>0.7.*</code></a>.</p>
<p>To illustrate this we will work an example.</p>
<p>Suppose you had worked out a <code>dplyr</code> pipeline that performed an analysis you were interested in. For an example we could take something similar to one of the examples from the <a href="https://blog.rstudio.com/2017/06/13/dplyr-0-7-0/"><code>dplyr</code> <code>0.7.0</code> announcement</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(<span class="st">"dplyr"</span>))
<span class="kw">packageVersion</span>(<span class="st">"dplyr"</span>)</code></pre></div>
<pre><code>## [1] '0.7.4'</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cat</span>(<span class="kw">colnames</span>(starwars), <span class="dt">sep =</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</code></pre></div>
<pre><code>## name
## height
## mass
## hair_color
## skin_color
## eye_color
## birth_year
## gender
## homeworld
## species
## films
## vehicles
## starships</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(homeworld) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">mean_height =</span> <span class="kw">mean</span>(height, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">mean_mass =</span> <span class="kw">mean</span>(mass, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">count =</span> <span class="kw"><a href="http://dplyr.tidyverse.org/reference/n.html">n</a></span>())</code></pre></div>
<pre><code>## # A tibble: 49 x 4
##         homeworld mean_height mean_mass count
##             &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;
##  1       Alderaan    176.3333      64.0     3
##  2    Aleen Minor     79.0000      15.0     1
##  3         Bespin    175.0000      79.0     1
##  4     Bestine IV    180.0000     110.0     1
##  5 Cato Neimoidia    191.0000      90.0     1
##  6          Cerea    198.0000      82.0     1
##  7       Champala    196.0000       NaN     1
##  8      Chandrila    150.0000       NaN     1
##  9   Concord Dawn    183.0000      79.0     1
## 10       Corellia    175.0000      78.5     2
## # ... with 39 more rows</code></pre>
<p>The above is colloquially called “an interactive script.” The name comes from the fact that we use names of variables (such as “<code>homeworld</code>”) that would only be known from looking at the data directly in the analysis code. Only somebody interacting with the data could write such a script (hence the name).</p>
<p>It has long been considered a point of discomfort to convert such an interactive <code>dplyr</code> pipeline into a re-usable script or function. That is a script or function that specifies column names in some <a href="http://www.win-vector.com/blog/2017/04/programming-over-r/">parametric</a> or re-usable fashion. Roughly it means the names of the data columns are not yet known when we are writing the code (and this is what makes the code re-usable).</p>
<p>This inessential (or conquerable) difficulty is largely a due to the preference for <a href="http://adv-r.had.co.nz/Computing-on-the-language.html">non-standard evaluation interfaces</a> (that is interfaces that capture and inspect un-evaluated expressions from their calling interface) in the design <code>dplyr</code>.</p>
<p><code>seplyr</code> is a <code>dplyr</code> adapter layer that prefers “slightly clunkier” standard interfaces (or <a href="https://en.wikipedia.org/wiki/Referential_transparency">referentially transparent</a> interfaces), which are actually very powerful and can be used to some advantage.</p>
<p>The above description and comparisons can come off as needlessly broad and painfully abstract. Things are much clearer if we move away from theory and return to our practical example.</p>
<p>Let’s translate the above example into a re-usable function in small (easy) stages. First translate the interactive script from <code>dplyr</code> notation into <code>seplyr</code> notation. This step is a pure <a href="https://en.wikipedia.org/wiki/Code_refactoring">re-factoring</a>, we are changing the code without changing its observable external behavior.</p>
<p>The translation is mechanical in that it is mostly using <code>seplyr</code> documentation as a lookup table. What you have to do is:</p>
<ul>
<li>Change <code>dplyr</code> verbs to their matching <code>seplyr</code> “<code>*_se()</code>” adapters.</li>
<li>Add quote marks around names and expressions.</li>
<li>Convert sequences of expressions (such as in the <code><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code>) to explicit vectors by adding the “<code>c()</code>” notation.</li>
<li>Replace “<code>=</code>” in expressions with “<code>:=</code>”.</li>
</ul>
<p>Our converted code looks like the following.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"seplyr"</span>)</code></pre></div>
<pre><code>## Loading required package: wrapr</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">starwars <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/group_by_se.html">group_by_se</a></span>(<span class="st">"homeworld"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/summarize_se.html">summarize_se</a></span>(<span class="kw">c</span>(<span class="st">"mean_height"</span> <span class="op">:</span><span class="er">=</span><span class="st"> "mean(height, na.rm = TRUE)"</span>,
                 <span class="st">"mean_mass"</span> <span class="op">:</span><span class="er">=</span><span class="st"> "mean(mass, na.rm = TRUE)"</span>,
                 <span class="st">"count"</span> <span class="op">:</span><span class="er">=</span><span class="st"> "n()"</span>))</code></pre></div>
<pre><code>## # A tibble: 49 x 4
##         homeworld mean_height mean_mass count
##             &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;
##  1       Alderaan    176.3333      64.0     3
##  2    Aleen Minor     79.0000      15.0     1
##  3         Bespin    175.0000      79.0     1
##  4     Bestine IV    180.0000     110.0     1
##  5 Cato Neimoidia    191.0000      90.0     1
##  6          Cerea    198.0000      82.0     1
##  7       Champala    196.0000       NaN     1
##  8      Chandrila    150.0000       NaN     1
##  9   Concord Dawn    183.0000      79.0     1
## 10       Corellia    175.0000      78.5     2
## # ... with 39 more rows</code></pre>
<p>This code works the same as the original <code>dplyr</code> code. Obviously at this point all we have done is: worked to make the code a bit less pleasant looking. We have yet to see any benefit from this conversion (though we can turn this on its head and say all the original <code>dplyr</code> notation is saving us is from having to write a few quote marks).</p>
<p>The benefit is: this new code can <em>very easily</em> be parameterized and wrapped in a re-usable function. In fact it is now simpler to do than to describe.</p>
<p>For example: suppose (<a href="https://blog.rstudio.com/2017/06/13/dplyr-0-7-0/">as in the original example</a>) we want to create a function that lets us choose the grouping variable? This is now easy, we copy the code into a function and replace the explicit value <code>"homeworld"</code> with a variable:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">starwars_mean &lt;-<span class="st"> </span><span class="cf">function</span>(my_var) {
  starwars <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/group_by_se.html">group_by_se</a></span>(my_var) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/summarize_se.html">summarize_se</a></span>(<span class="kw">c</span>(<span class="st">"mean_height"</span> <span class="op">:</span><span class="er">=</span><span class="st"> "mean(height, na.rm = TRUE)"</span>,
                   <span class="st">"mean_mass"</span> <span class="op">:</span><span class="er">=</span><span class="st"> "mean(mass, na.rm = TRUE)"</span>,
                   <span class="st">"count"</span> <span class="op">:</span><span class="er">=</span><span class="st"> "n()"</span>))
}

<span class="kw">starwars_mean</span>(<span class="st">"hair_color"</span>)</code></pre></div>
<pre><code>## # A tibble: 13 x 4
##       hair_color mean_height mean_mass count
##            &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;
##  1        auburn    150.0000       NaN     1
##  2  auburn, grey    180.0000       NaN     1
##  3 auburn, white    182.0000  77.00000     1
##  4         black    174.3333  73.05714    13
##  5         blond    176.6667  80.50000     3
##  6        blonde    168.0000  55.00000     1
##  7         brown    175.2667  79.27273    18
##  8   brown, grey    178.0000 120.00000     1
##  9          grey    170.0000  75.00000     1
## 10          none    180.8889  78.51852    37
## 11       unknown         NaN       NaN     1
## 12         white    156.0000  59.66667     4
## 13          &lt;NA&gt;    141.6000 314.20000     5</code></pre>
<p>In <code>seplyr</code> programming is easy (just replace values with variables). For example we can make a completely generic re-usable “grouped mean” function using <code>R</code>’s <code>paste()</code> function to build up expressions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grouped_mean &lt;-<span class="st"> </span><span class="cf">function</span>(data, 
                         grouping_variables, 
                         value_variables) {
  result_names &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">"mean_"</span>, 
                         value_variables)
  expressions &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">"mean("</span>, 
                        value_variables, 
                        <span class="st">", na.rm = TRUE)"</span>)
  calculation &lt;-<span class="st"> </span>result_names <span class="op">:</span><span class="er">=</span><span class="st"> </span>expressions
  <span class="kw">print</span>(<span class="kw">as.list</span>(calculation)) <span class="co"># print for demonstration</span>
  data <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/group_by_se.html">group_by_se</a></span>(grouping_variables) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/summarize_se.html">summarize_se</a></span>(<span class="kw">c</span>(calculation,
                   <span class="st">"count"</span> <span class="op">:</span><span class="er">=</span><span class="st"> "n()"</span>))
}

starwars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">grouped_mean</span>(<span class="dt">grouping_variables =</span> <span class="st">"eye_color"</span>,
               <span class="dt">value_variables =</span> <span class="kw">c</span>(<span class="st">"mass"</span>, <span class="st">"birth_year"</span>))</code></pre></div>
<pre><code>## $mean_mass
## [1] "mean(mass, na.rm = TRUE)"
## 
## $mean_birth_year
## [1] "mean(birth_year, na.rm = TRUE)"</code></pre>
<pre><code>## # A tibble: 15 x 4
##        eye_color mean_mass mean_birth_year count
##            &lt;chr&gt;     &lt;dbl&gt;           &lt;dbl&gt; &lt;int&gt;
##  1         black  76.28571        33.00000    10
##  2          blue  86.51667        67.06923    19
##  3     blue-gray  77.00000        57.00000     1
##  4         brown  66.09231       108.96429    21
##  5          dark       NaN             NaN     1
##  6          gold       NaN             NaN     1
##  7 green, yellow 159.00000             NaN     1
##  8         hazel  66.00000        34.50000     3
##  9        orange 282.33333       231.00000     8
## 10          pink       NaN             NaN     1
## 11           red  81.40000        33.66667     5
## 12     red, blue       NaN             NaN     1
## 13       unknown  31.50000             NaN     3
## 14         white  48.00000             NaN     1
## 15        yellow  81.11111        76.38000    11</code></pre>
<p>The only part that requires more study and practice was messing around with the expressions using <code>paste0()</code> (for more details on the string manipulation please try “<code>help(paste)</code>”). Notice also we used the “<code>:=</code>” operator to bind the list of desired result names to the matching calculations (please see “<code>help(named_map_builder)</code>” for more details).</p>
<p>We can also use <code>gsub</code> or the <code>glue</code> package for the same effect:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span>(<span class="kw">requireNamespace</span>(<span class="st">'glue'</span>, <span class="dt">quietly =</span> <span class="ot">TRUE</span>)) {
  <span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(<span class="st">"glue"</span>))
  
  grouped_mean &lt;-<span class="st"> </span><span class="cf">function</span>(data, 
                           grouping_variables, 
                           value_variables) {
    data <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="../reference/group_by_se.html">group_by_se</a></span>(grouping_variables) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw"><a href="../reference/summarize_se.html">summarize_se</a></span>(<span class="kw">c</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"mean_{value_variables}"</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span>
<span class="st">                     </span><span class="kw"><a href="http://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"mean({value_variables}, na.rm = TRUE)"</span>),
                     <span class="st">"count"</span> <span class="op">:</span><span class="er">=</span><span class="st"> "n()"</span>))
  }
  
  starwars <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">grouped_mean</span>(<span class="dt">grouping_variables =</span> <span class="st">"eye_color"</span>,
                 <span class="dt">value_variables =</span> <span class="kw">c</span>(<span class="st">"mass"</span>, <span class="st">"birth_year"</span>))
}</code></pre></div>
<pre><code>## # A tibble: 15 x 4
##        eye_color mean_mass mean_birth_year count
##            &lt;chr&gt;     &lt;dbl&gt;           &lt;dbl&gt; &lt;int&gt;
##  1         black  76.28571        33.00000    10
##  2          blue  86.51667        67.06923    19
##  3     blue-gray  77.00000        57.00000     1
##  4         brown  66.09231       108.96429    21
##  5          dark       NaN             NaN     1
##  6          gold       NaN             NaN     1
##  7 green, yellow 159.00000             NaN     1
##  8         hazel  66.00000        34.50000     3
##  9        orange 282.33333       231.00000     8
## 10          pink       NaN             NaN     1
## 11           red  81.40000        33.66667     5
## 12     red, blue       NaN             NaN     1
## 13       unknown  31.50000             NaN     3
## 14         white  48.00000             NaN     1
## 15        yellow  81.11111        76.38000    11</code></pre>
<p>The point is: we did not have to bring in (or study) any deep-theory or heavy-weight tools such as <a href="https://CRAN.R-project.org/package=rlang"><code>rlang</code>/<code>tidyeval</code></a> or <a href="https://CRAN.R-project.org/package=lazyeval"><code>lazyeval</code></a> to complete our programming task. Once you are in <code>seplyr</code> notation, changes are very easy. You can separate translating into <code>seplyr</code> notation from the work of designing your wrapper function (breaking your programming work into smaller easier to understand steps).</p>
<p>The <code>seplyr</code> methodology is simple, easy to teach, and powerful. The package contains a number of worked examples both in <code>help()</code> and <a href="https://winvector.github.io/seplyr/articles/seplyr.html"><code><a href="https://cran.rstudio.com/web/packages/seplyr/vignettes/seplyr.html">vignette(package='seplyr')</a></code></a> documentation. For more details please also see: <a href="https://winvector.github.io/wrapr/reference/named_map_builder.html"><code>help(</code>:=<code>, package = 'wrapr')</code></a> and <a href="https://winvector.github.io/wrapr/reference/grapes-.-greater-than-grapes.html"><code>help("%.&gt;%", package="wrapr")</code></a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
